<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KarrotDEX ‚Äî Swap Any Token</title>
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --karrot-orange: #FF7F11;
      --karrot-light: #FFB84C;
      --bg-dark: #0a0a0a;
    }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--karrot-orange);
      min-height: 100vh;
    }
    
    #loading-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #0a0a0a, #1a1a1a, #0a0a0a);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 1000;
      transition: opacity 0.8s ease-out;
    }
    
    #loading-container.fade-out { opacity: 0; pointer-events: none; }
    
    #loading-text {
      position: absolute; bottom: 18%;
      text-align: center; color: var(--karrot-orange);
      z-index: 10;
      text-shadow: 0 0 30px rgba(255, 127, 17, 0.8);
    }
    
    #loading-text h1 {
      font-size: 2.5rem; font-weight: 700; letter-spacing: 0.2em;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .subtitle { font-size: 0.9rem; opacity: 0.8; letter-spacing: 0.15em; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    #progress-bar { position: absolute; bottom: 12%; width: 250px; height: 4px;
      background: rgba(255, 127, 17, 0.15); border-radius: 2px; overflow: hidden; }
    #progress-fill { height: 100%; width: 0%;
      background: linear-gradient(90deg, #FF7F11, #FFB84C);
      transition: width 0.3s ease; }
    
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
    
    #dex-app { opacity: 0; transition: opacity 0.5s ease-in; padding: 20px;
      max-width: 480px; margin: 0 auto; }
    #dex-app.loaded { opacity: 1; }
    
    header { display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 0; margin-bottom: 2rem; }
    .logo { display: flex; align-items: center; gap: 0.5rem;
      font-size: 1.5rem; font-weight: 700; }
    
    #connectWallet {
      background: linear-gradient(135deg, var(--karrot-orange), var(--karrot-light));
      color: #000; border: none; padding: 0.75rem 1.5rem;
      border-radius: 12px; font-weight: 600; cursor: pointer; }
    #connectWallet:hover { transform: translateY(-2px); }
    
    .card { background: linear-gradient(145deg, #151515, #0d0d0d);
      border: 1px solid #2a2a2a; border-radius: 20px; padding: 1.5rem; margin-bottom: 1rem; }
    .card:hover { border-color: var(--karrot-orange); }
    
    .dex-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    
    #aggregatorLogo {
      width: 48px; height: 48px; border-radius: 50%;
      border: 2px solid var(--karrot-orange);
      display: flex; align-items: center; justify-content: center;
      background: rgba(255, 127, 17, 0.1); overflow: hidden; cursor: pointer; }
    #aggregatorLogo:hover { transform: scale(1.05); }
    #aggregatorLogo img { width: 32px; height: 32px; object-fit: contain; }
    
    select { width: 100%; padding: 0.75rem; background: #1a1a1a;
      border: 1px solid #333; border-radius: 10px; color: var(--karrot-orange);
      font-size: 0.9rem; cursor: pointer; }
    select:hover { border-color: var(--karrot-orange); }
    
    #aggregatorInfo { font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;
      display: flex; align-items: center; gap: 0.5rem; }
    .chain-badge { background: rgba(255, 127, 17, 0.2); padding: 2px 8px;
      border-radius: 12px; font-size: 0.75rem; }
    
    .swap-box { background: #1a1a1a; border: 1px solid #333;
      border-radius: 16px; padding: 1rem; margin-bottom: 0.5rem; }
    .swap-box:focus-within { border-color: var(--karrot-orange); }
    
    .swap-input-row { display: flex; align-items: center; gap: 0.5rem;
      justify-content: space-between; }
    
    .amount-input { flex: 1; background: transparent; border: none;
      color: var(--karrot-orange); font-size: 1.75rem; font-weight: 600;
      outline: none; width: 100%; }
    .amount-input::placeholder { color: #555; }
    
    .token-select-btn { display: flex; align-items: center; gap: 0.5rem;
      background: #2a2a2a; border: 1px solid #333; border-radius: 12px;
      padding: 0.5rem 0.75rem; color: var(--karrot-orange); font-weight: 600;
      cursor: pointer; min-width: 120px; }
    .token-select-btn:hover { border-color: var(--karrot-orange); }
    .token-select-btn img { width: 28px; height: 28px; border-radius: 50%; }
    
    .switch-container { display: flex; justify-content: center; margin: -0.5rem 0;
      position: relative; z-index: 10; }
    #switchTokens { background: #1a1a1a; border: 2px solid var(--karrot-orange);
      border-radius: 50%; width: 44px; height: 44px; display: flex;
      align-items: center; justify-content: center; font-size: 1.2rem;
      color: var(--karrot-orange); cursor: pointer; }
    #switchTokens:hover { background: var(--karrot-orange); color: #000; }
    
    .price-info { background: #1a1a1a; border-radius: 12px; padding: 1rem; margin: 1rem 0; }
    .price-row { display: flex; justify-content: space-between;
      padding: 0.5rem 0; border-bottom: 1px solid #2a2a2a; font-size: 0.85rem; }
    .price-row:last-child { border-bottom: none; }
    .price-label { opacity: 0.7; }
    .price-value { font-weight: 600; }
    
    .slippage-container { margin: 1rem 0; }
    .slippage-label { font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.8; }
    .slippage-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .slippage-btn { background: #2a2a2a; border: 1px solid #333;
      border-radius: 8px; padding: 0.5rem 1rem; color: var(--karrot-orange);
      cursor: pointer; }
    .slippage-btn:hover, .slippage-btn.active { background: var(--karrot-orange);
      border-color: var(--karrot-orange); color: #000; }
    #slippage { width: 80px; padding: 0.5rem; background: #2a2a2a;
      border: 1px solid #333; border-radius: 8px; color: var(--karrot-orange);
      text-align: center; }
    
    /* CUSTOM ADDRESS SECTION - RESTORED */
    .custom-address-box { background: #1a1a1a; border: 1px solid #333;
      border-radius: 12px; padding: 1rem; margin: 1rem 0; }
    .custom-address-toggle { display: flex; align-items: center; gap: 0.5rem;
      cursor: pointer; margin-bottom: 0.5rem; }
    #useCustomAddress { width: 18px; height: 18px; accent-color: #FF7F11;
      cursor: pointer; }
    #customAddress { width: 100%; padding: 0.75rem; background: #0a0a0a;
      border: 1px solid #333; border-radius: 8px; color: var(--karrot-orange);
      margin-top: 0.5rem; display: none; }
    #customAddress.show { display: block; border-color: var(--karrot-orange); }
    #customAddressNote { font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem; display: none; }
    #customAddressNote.show { display: block; }
    
    .api-status { display: flex; align-items: center; gap: 0.5rem;
      font-size: 0.75rem; opacity: 0.7; margin: 0.5rem 0; }
    .api-status.connected { color: #00ff88; }
    
    #btnSwap { width: 100%; padding: 1.25rem;
      background: linear-gradient(135deg, var(--karrot-orange), var(--karrot-light));
      border: none; border-radius: 16px; color: #000; font-size: 1.25rem;
      font-weight: 700; cursor: pointer; margin-top: 1rem; }
    #btnSwap:hover { transform: translateY(-2px); }
    
    .live-indicator { display: inline-flex; align-items: center; gap: 0.5rem;
      font-size: 0.75rem; margin-left: 0.5rem; }
    .live-dot { width: 6px; height: 6px; background: #00ff88;
      border-radius: 50%; animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    
    .token-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 1001; display: flex;
      align-items: center; justify-content: center; }
    .token-modal-content { background: #151515; border: 1px solid #333;
      border-radius: 20px; padding: 1.5rem; max-height: 80vh;
      overflow-y: auto; width: 90%; max-width: 400px; }
    .token-item { display: flex; align-items: center; gap: 0.75rem;
      padding: 0.75rem; cursor: pointer; border-radius: 8px;
      transition: background 0.2s; }
    .token-item:hover { background: #2a2a2a; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-container">
    <div id="loading-text">
      <h1>ü•ï KARROT DEX</h1>
      <div class="subtitle">LOADING TRADING INTERFACE</div>
    </div>
    <div id="progress-bar">
      <div id="progress-fill"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="dex-app">
    <header>
      <div class="logo">
        <span>ü•ï</span>
        <span>KarrotDEX</span>
      </div>
      <button id="connectWallet">Connect Wallet</button>
    </header>

    <div class="card">
      <div class="dex-header">
        <div id="aggregatorLogo">
          <img src="https://cryptologos.cc/logos/pulsechain-pulse-logo.svg" alt="DEX Logo" id="dexLogoImg">
        </div>
        <div style="flex: 1;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Select DEX</label>
          <select id="aggregator">
            <optgroup label="PulseChain">
              <option value="PulseX">üü¢ PulseX V2</option>
              <option value="9mm">üî´ 9mm</option>
              <option value="Piteas">ü•ß Piteas</option>
              <option value="PulseXV3">üü¢ PulseX V3</option>
            </optgroup>
            <optgroup label="Ethereum">
              <option value="UniswapV3">ü¶Ñ Uniswap V3</option>
              <option value="SushiSwap">üç£ SushiSwap</option>
              <option value="1inch">üìä 1inch</option>
            </optgroup>
          </select>
          <div id="aggregatorInfo">
            <span class="chain-badge">Chain ID: 369</span>
            <span id="priceSource">PulseX ‚Äî Live</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <!-- From Token -->
      <div class="swap-box">
        <div class="swap-input-row">
          <span style="font-size: 0.85rem; opacity: 0.8;">From</span>
          <span id="balanceFrom" style="font-size: 0.85rem; opacity: 0.8;">Balance: --</span>
        </div>
        <div class="swap-input-row" style="margin-top: 0.5rem;">
          <input type="number" id="amountFrom" class="amount-input" placeholder="0.0" step="any" min="0">
          <button class="token-select-btn" id="fromTokenBtn">
            <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" alt="token" id="fromTokenImg">
            <span id="fromTokenSymbol">ETH</span>
          </button>
        </div>
      </div>

      <div class="switch-container">
        <button id="switchTokens">‚áÖ</button>
      </div>

      <!-- To Token -->
      <div class="swap-box">
        <div class="swap-input-row">
          <span style="font-size: 0.85rem; opacity: 0.8;">To</span>
          <span id="balanceTo" style="font-size: 0.85rem; opacity: 0.8;">Balance: --</span>
        </div>
        <div class="swap-input-row" style="margin-top: 0.5rem;">
          <div id="amountToDisplay" class="amount-input" style="color: #888;">0.0</div>
          <button class="token-select-btn" id="toTokenBtn">
            <img src="https://cryptologos.cc/logos/pulsechain-pulse-logo.png" alt="token" id="toTokenImg">
            <span id="toTokenSymbol">PLS</span>
          </button>
        </div>
      </div>

      <!-- Price Info -->
      <div class="price-info">
        <div class="price-row">
          <span class="price-label">
            Rate
            <span class="live-indicator"><span class="live-dot"></span>LIVE</span>
          </span>
          <span id="exchangeRate" class="price-value">--</span>
        </div>
        <div class="price-row">
          <span class="price-label">Price Impact</span>
          <span id="priceImpact" class="price-value">--</span>
        </div>
        <div class="price-row">
          <span class="price-label">Minimum Received</span>
          <span id="minReceived" class="price-value">--</span>
        </div>
        <div class="price-row">
          <span class="price-label">Network Fee</span>
          <span id="networkFee" class="price-value">--</span>
        </div>
      </div>

      <div class="slippage-container">
        <div class="slippage-label">Slippage Tolerance</div>
        <div class="slippage-buttons">
          <button class="slippage-btn active" data-value="0.5">0.5%</button>
          <button class="slippage-btn" data-value="1">1%</button>
          <button class="slippage-btn" data-value="2">2%</button>
          <input type="number" id="customSlippage" placeholder="Custom" min="0.1" max="50" step="0.1">
        </div>
      </div>

      <!-- CUSTOM ADDRESS SECTION - RESTORED -->
      <div class="custom-address-box">
        <label class="custom-address-toggle">
          <input type="checkbox" id="useCustomAddress">
          <span>Send to different address (optional)</span>
        </label>
        <input type="text" id="customAddress" placeholder="Enter destination address (0x... for ETH/PLS, or BTC/SOL address)">
        <p id="customAddressNote">Supports: Ethereum (0x...), Bitcoin, Solana, THORChain addresses</p>
      </div>

      <div class="api-status" id="apiStatus">
        <span>‚óè</span> <span>Loading prices...</span>
      </div>

      <button id="btnSwap">Swap</button>
    </div>
  </div>

  <script src="price-service.js"></script>
  
  <script>
    // Token list
    const TOKENS = [
      { symbol: 'ETH', name: 'Ethereum', logo: 'https://cryptologos.cc/logos/ethereum-eth-logo.png' },
      { symbol: 'WETH', name: 'Wrapped ETH', logo: 'https://cryptologos.cc/logos/wrapped-ether-weth-logo.png' },
      { symbol: 'USDC', name: 'USD Coin', logo: 'https://cryptologos.cc/logos/usd-coin-usdc-logo.png' },
      { symbol: 'USDT', name: 'Tether', logo: 'https://cryptologos.cc/logos/tether-usdt-logo.png' },
      { symbol: 'DAI', name: 'Dai', logo: 'https://cryptologos.cc/logos/multi-collateral-dai-dai-logo.png' },
      { symbol: 'BTC', name: 'Bitcoin', logo: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png' },
      { symbol: 'WBTC', name: 'Wrapped BTC', logo: 'https://cryptologos.cc/logos/wrapped-bitcoin-wbtc-logo.png' },
      { symbol: 'PLS', name: 'PulseChain', logo: 'https://cryptologos.cc/logos/pulsechain-pulse-logo.png' },
      { symbol: 'WPLS', name: 'Wrapped PLS', logo: 'https://cryptologos.cc/logos/pulsechain-pulse-logo.png' },
      { symbol: 'BNB', name: 'BNB', logo: 'https://cryptologos.cc/logos/bnb-bnb-logo.png' },
      { symbol: 'SOL', name: 'Solana', logo: 'https://cryptologos.cc/logos/solana-sol-logo.png' },
      { symbol: 'UNI', name: 'Uniswap', logo: 'https://cryptologos.cc/logos/uniswap-uni-logo.png' },
      { symbol: 'LINK', name: 'Chainlink', logo: 'https://cryptologos.cc/logos/chainlink-link-logo.png' },
      { symbol: 'AAVE', name: 'Aave', logo: 'https://cryptologos.cc/logos/aave-aave-logo.png' },
      { symbol: 'MATIC', name: 'Polygon', logo: 'https://cryptologos.cc/logos/polygon-matic-logo.png' }
    ];

    let fromToken = 'ETH', toToken = 'PLS', slippage = 0.5;

    // Custom address toggle
    document.getElementById('useCustomAddress').addEventListener('change', function() {
      const addressInput = document.getElementById('customAddress');
      const note = document.getElementById('customAddressNote');
      addressInput.classList.toggle('show', this.checked);
      note.classList.toggle('show', this.checked);
    });

    // Token selector
    function showTokenModal(type) {
      const modal = document.createElement('div');
      modal.className = 'token-modal';
      modal.innerHTML = `
        <div class="token-modal-content">
          <h3 style="margin-bottom: 1rem; color: #FF7F11;">Select Token</h3>
          <input type="text" placeholder="Search..." style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333; border-radius: 10px; color: #FF7F11; margin-bottom: 1rem;">
          <div id="tokenList">${TOKENS.map(t => `
            <div class="token-item" data-symbol="${t.symbol}">
              <img src="${t.logo}" style="width: 32px; height: 32px; border-radius: 50%;">
              <div>
                <div style="font-weight: 600; color: #FF7F11;">${t.symbol}</div>
                <div style="font-size: 0.8rem; opacity: 0.7;">${t.name}</div>
              </div>
            </div>
          `).join('')}</div>
        </div>
      `;

      modal.querySelectorAll('.token-item').forEach(item => {
        item.addEventListener('click', () => {
          const symbol = item.dataset.symbol;
          if (type === 'from') {
            fromToken = symbol;
            updateTokenDisplay('from', symbol);
          } else {
            toToken = symbol;
            updateTokenDisplay('to', symbol);
          }
          modal.remove();
          fetchPrice();
        });
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);
    }

    function updateTokenDisplay(type, symbol) {
      const token = TOKENS.find(t => t.symbol === symbol);
      if (token) {
        document.getElementById(`${type}TokenImg`).src = token.logo;
        document.getElementById(`${type}TokenSymbol`).textContent = symbol;
      }
    }

    document.getElementById('fromTokenBtn').addEventListener('click', () => showTokenModal('from'));
    document.getElementById('toTokenBtn').addEventListener('click', () => showTokenModal('to'));

    // Switch tokens
    document.getElementById('switchTokens').addEventListener('click', () => {
      [fromToken, toToken] = [toToken, fromToken];
      updateTokenDisplay('from', fromToken);
      updateTokenDisplay('to', toToken);
      fetchPrice();
    });

    // Slippage
    document.querySelectorAll('.slippage-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.slippage-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        slippage = parseFloat(btn.dataset.value);
        fetchPrice();
      });
    });

    document.getElementById('customSlippage')?.addEventListener('change', (e) => {
      slippage = parseFloat(e.target.value) || 0.5;
      fetchPrice();
    });

    // Amount input
    let debounceTimer;
    document.getElementById('amountFrom').addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fetchPrice, 500);
    });

    // Fetch price - WORKING VERSION
    async function fetchPrice() {
      const amount = parseFloat(document.getElementById('amountFrom').value) || 0;
      if (amount <= 0) {
        document.getElementById('amountToDisplay').textContent = '0.0';
        return;
      }

      document.getElementById('exchangeRate').textContent = 'Loading...';

      try {
        // Use PriceService.getChangeNowRate (now properly exposed)
        let rateData;
        if (window.PriceService && window.PriceService.getChangeNowRate) {
          rateData = await window.PriceService.getChangeNowRate(fromToken, toToken, amount);
        } else {
          // Fallback to CoinGecko directly
          rateData = await fetchCoinGeckoRate(fromToken, toToken, amount);
        }

        const rate = rateData.rate || 1;
        const estimated = rate * amount;
        const minReceived = estimated * (1 - slippage / 100);

        document.getElementById('amountToDisplay').textContent = estimated.toFixed(6);
        document.getElementById('amountToDisplay').style.color = '#FF7F11';
        document.getElementById('exchangeRate').textContent = `1 ${fromToken} = ${rate.toFixed(6)} ${toToken}`;
        document.getElementById('minReceived').textContent = `${minReceived.toFixed(6)} ${toToken}`;
        document.getElementById('priceImpact').textContent = '0.5%';
        document.getElementById('networkFee').textContent = '~$2.50';

        document.getElementById('apiStatus').innerHTML = `<span style="color: #00ff88;">‚óè</span> <span>Live from ${rateData.source || 'API'}</span>`;
      } catch (e) {
        console.error('Price error:', e);
        document.getElementById('exchangeRate').textContent = 'Price unavailable';
      }
    }

    // Direct CoinGecko fallback
    async function fetchCoinGeckoRate(from, to, amount) {
      const ids = { ETH: 'ethereum', BTC: 'bitcoin', PLS: 'pulsechain', 
                   USDC: 'usd-coin', USDT: 'tether', DAI: 'dai', 
                   BNB: 'binancecoin', SOL: 'solana', UNI: 'uniswap',
                   LINK: 'chainlink', AAVE: 'aave', MATIC: 'matic-network' };
      
      const fromId = ids[from], toId = ids[to];
      if (!fromId || !toId) return { rate: 1, source: 'mock' };

      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${fromId},${toId}&vs_currencies=usd`);
      const data = await res.json();
      const rate = (data[fromId]?.usd || 1) / (data[toId]?.usd || 1);
      return { rate, source: 'CoinGecko' };
    }

    // DEX change
    document.getElementById('aggregator').addEventListener('change', function() {
      const logos = {
        'PulseX': 'https://cryptologos.cc/logos/pulsechain-pulse-logo.svg',
        '9mm': 'https://assets.coingecko.com/coins/images/31524/small/9mm_token.png',
        'Piteas': 'https://assets.coingecko.com/coins/images/31525/small/piteas.png',
        'UniswapV3': 'https://cryptologos.cc/logos/uniswap-uni-logo.svg',
        'SushiSwap': 'https://cryptologos.cc/logos/sushiswap-sushi-logo.svg',
        '1inch': 'https://cryptologos.cc/logos/1inch-1inch-logo.svg'
      };
      document.getElementById('dexLogoImg').src = logos[this.value] || logos['PulseX'];
    });

    // Loading animation
    function simulateLoading() {
      const bar = document.getElementById('progress-fill');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15 + 5;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('loading-container').classList.add('fade-out');
            document.getElementById('dex-app').classList.add('loaded');
            setTimeout(() => {
              document.getElementById('loading-container').style.display = 'none';
            }, 800);
          }, 500);
        }
        bar.style.width = progress + '%';
      }, 150);
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      if (window.PriceService) window.PriceService.init();
      simulateLoading();
      updateTokenDisplay('from', fromToken);
      updateTokenDisplay('to', toToken);
    });

    // Auto-refresh prices
    setInterval(fetchPrice, 30000);
  </script>
</body>
</html>
